!function(){angular.module("taiga.plugins.notes",["ngRoute"]).config(["$routeProvider",function(t){return t.when("/notes",{templateUrl:"partials/notes.html",controller:"NotesListController"}).when("/notes/create",{templateUrl:"partials/note-edit.html",controller:"NoteEditPageController"}).when("/notes/:id/edit",{templateUrl:"partials/note-edit.html",controller:"NoteEditPageController"}).otherwise({redirectTo:"/notes"})}])}.call(this),function(){angular.module("taiga.plugins.notes").controller("NotesListController",["$scope","$location","$http",function(n,e,o){var r="http://127.0.0.1:8000/api";return n.notes=[],n.searchQuery="",n.loadNotes=function(){return o.get(r+"/notes/").then(function(t){return n.notes=t.data})},n.goToCreate=function(){return e.path("/notes/create")},n.editNote=function(t){return e.path("/notes/"+t.id+"/edit")},n.downloadNote=function(t){var n=new Blob([t.current_version_content||""],{type:"text/html"}),e=document.createElement("a");return e.href=URL.createObjectURL(n),e.download=`${t.name||"note"}.html`,e.click()},n.deleteNote=function(t){if(confirm(`Bạn có chắc muốn xóa ghi chú '${t.name}'?`))return o.delete(r+`/notes/${t.id}/`).then(function(){return n.loadNotes()})},n.getUpdatedAt=function(n){var t;return n.current_version_id&&n.versions&&(null!=(t=n.versions.find(function(t){return t.id===n.current_version_id}))?t.created_at:void 0)||n.created_at},n.loadNotes()}]),angular.module("taiga.plugins.notes").controller("NoteEditPageController",["$scope","$location","$timeout","$routeParams","$http",function(n,e,o,t,r){var i,c="http://127.0.0.1:8000/api",s=null!=(t=t.id)?t:null;return n.note={name:"",content:"",creator:1},n.versions=[],n.selectedVersion=null,t=function(){return null!=s?r.get(c+`/notes/${s}/`).then(function(t){return n.note=t.data,n.versions=n.note.versions||[],n.selectedVersion=n.versions.find(function(t){return t.id===n.note.current_version_id}),o(i,0)},function(t){return alert("Note không tồn tại hoặc lỗi server."),e.path("/notes")}):(n.versions=[],n.note={name:"",content:"",creator:1},n.selectedVersion=null,o(i,0))},n.selectVersion=function(t){if(n.selectedVersion=t,null!=window.editorInstance)return window.editorInstance.setData(t.content||"")},n.restoreSelectedVersion=function(){var t=n.selectedVersion;if(t&&t.id!==n.note.current_version_id)return r.post(c+`/notes/${s}/restore_version/`,{version_id:t.id}).then(function(t){if(n.note=t.data,n.versions=n.note.versions||[],n.selectedVersion=n.versions.find(function(t){return t.id===n.note.current_version_id}),null!=window.editorInstance)return window.editorInstance.setData(n.note.current_version_content||"")});alert("Vui lòng chọn version khác version hiện tại để phục hồi!")},i=function(){return null!=window.editorInstance&&window.editorInstance.destroy(),ClassicEditor.create(document.querySelector("#noteContent")).then(function(t){return(window.editorInstance=t).model.document.on("change:data",function(){return n.$$phase?n.note.content=t.getData():n.$apply(function(){return n.note.content=t.getData()})}),t.setData(n.note.current_version_content||"")}).catch(function(t){return console.error("CKEditor init failed:",t)})},n.save=function(){var t;return null!=window.editorInstance&&(n.note.content=window.editorInstance.getData()),t={name:n.note.name,content:n.note.content,creator:n.note.creator},null!=s?r.put(c+`/notes/${s}/`,t).then(function(){return e.path("/notes")}):r.post(c+"/notes/",t).then(function(t){return e.path("/notes")})},n.back=function(){return e.path("/notes")},n.$on("$destroy",function(){if(null!=window.editorInstance)return window.editorInstance.destroy(),window.editorInstance=null}),t()}])}.call(this);